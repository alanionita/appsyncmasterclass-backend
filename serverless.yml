service: appsyncmasterclass-backend
frameworkVersion: "3"

plugins:
  - serverless-appsync-plugin

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-west-2 

package:
  exclude: 
    - package-lock.json
    - package.json

appSync: ${file(./serverless/appsync.yml)}

custom:
  stage: ${opt:stage, self:provider.stage}

# you can add CloudFormation resource templates here
resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        Tags:
          - Key: Environment
            Value: ${self:custom.stage}
          - Key: Name
            Value: users-table
          - Key: CanIDelete
            Value: 'No'
          - Key: Author
            Value: 'Alan Ionita'
          - Key: CreatedOn
            Value: 2025-03-04
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireNumbers: true
            RequireUppercase: true
            RequireSymbols: true
            RequireLowercase: false
        UsernameAttributes:
          - email
        Schema:
          - AttributeDataType: String
            Name: name  
            Required: false
            Mutable: true
    WebUserPoolClient:
        Type: AWS::Cognito::UserPoolClient
        Properties:
            UserPoolId: !Ref CognitoUserPool
            ClientName: web
            PreventUserExistenceErrors: ENABLED
            ExplicitAuthFlows:
              - ALLOW_USER_SRP_AUTH
              - ALLOW_USER_PASSWORD_AUTH
              - ALLOW_REFRESH_TOKEN_AUTH
  Outputs:
    CognitoUserPoolId:
      Description: "Cognito User Pool ::"
      Value: !Ref CognitoUserPool
