confirmUserSignup:
  handler: functions/confirm-user-signup.handler
  environment:
    USERS_TABLE: !Ref UsersTable
  iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:PutItem
      Resource: !GetAtt UsersTable.Arn

preUserSignup:
  handler: functions/pre-user-signup.handler

getImageUploadUrl: 
  handler: functions/get-img-upload-url.handler
  environment:
    BUCKET_NAME: !Ref AssetsBucket
  iamRoleStatements:
    - Effect: Allow
      Action: 
        - s3:PutObject
        - s3:PutObjectAcl
      Resource: !Sub ${AssetsBucket.Arn}/*

getImagePresignedUrl: 
  handler: functions/get-img-presigned-url.handler
  environment:
    BUCKET_NAME: !Ref AssetsBucket
  iamRoleStatements:
    - Effect: Allow
      Action: 
        - s3:GetObject
      Resource: !Sub ${AssetsBucket.Arn}/*
tweet:
  handler: functions/tweet.handler
  environment:
    USERS_TABLE: !Ref UsersTable
    TWEETS_TABLE: !Ref TweetsTable
    TIMELINES_TABLE: !Ref TimelinesTable
  iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:UpdateItem
      Resource: !GetAtt UsersTable.Arn
    - Effect: Allow
      Action: dynamodb:PutItem
      Resource: 
        - !GetAtt TweetsTable.Arn
        - !GetAtt TimelinesTable.Arn

retweet:
  handler: functions/retweet.handler
  environment:
    USERS_TABLE: !Ref UsersTable
    TWEETS_TABLE: !Ref TweetsTable
    TIMELINES_TABLE: !Ref TimelinesTable
    RETWEETS_TABLE: !Ref RetweetsTable
  iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:GetItem
      Resource: 
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:UpdateItem
      Resource: 
        - !GetAtt UsersTable.Arn
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:PutItem
      Resource: 
        - !GetAtt TweetsTable.Arn
        - !GetAtt TimelinesTable.Arn
        - !GetAtt RetweetsTable.Arn

unretweet:
  handler: functions/unretweet.handler
  environment:
    USERS_TABLE: !Ref UsersTable
    TWEETS_TABLE: !Ref TweetsTable
    TIMELINES_TABLE: !Ref TimelinesTable
    RETWEETS_TABLE: !Ref RetweetsTable
  iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:GetItem
      Resource: 
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:Query
      Resource: 
        - !Sub "${TweetsTable.Arn}/index/retweets"
    - Effect: Allow
      Action: dynamodb:UpdateItem
      Resource: 
        - !GetAtt UsersTable.Arn
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:DeleteItem
      Resource: 
        - !GetAtt TweetsTable.Arn
        - !GetAtt TimelinesTable.Arn
        - !GetAtt RetweetsTable.Arn

reply:
  handler: functions/reply.handler
  environment:
    USERS_TABLE: !Ref UsersTable
    TWEETS_TABLE: !Ref TweetsTable
    TIMELINES_TABLE: !Ref TimelinesTable
    RETWEETS_TABLE: !Ref RetweetsTable
  iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:GetItem
      Resource: 
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:UpdateItem
      Resource: 
        - !GetAtt UsersTable.Arn
        - !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: dynamodb:PutItem
      Resource: 
        - !GetAtt TweetsTable.Arn
        - !GetAtt TimelinesTable.Arn
        - !GetAtt RetweetsTable.Arn

distributeTweets:
  handler: functions/distributeTweets.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt TweetsTable.StreamArn
  environment:
    RELATIONSHIPS_TABLE: !Ref RelationshipsTable
    TIMELINES_TABLE: !Ref TimelinesTable
  iamRoleStatements:
    - Effect: Allow
      Action: 
        - dynamodb:PutItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
      Resource: !GetAtt TimelinesTable.Arn
    - Effect: Allow
      Action: dynamodb:Query
      Resource: !Sub "${RelationshipsTable.Arn}/index/byOtherUser"

distributeTweetsToFollower:
  handler: functions/distributeTweetsToFollower.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt RelationshipsTable.StreamArn
  environment:
    TWEETS_TABLE: !Ref TweetsTable
    TIMELINES_TABLE: !Ref TimelinesTable
    MAX_TWEETS: 100
  iamRoleStatementsName: ${self:service}-${self:custom.stage}-distributeTweetsToFollower 
  iamRoleStatements:
    - Effect: Allow
      Action: 
        - dynamodb:PutItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
      Resource: !GetAtt TimelinesTable.Arn
    - Effect: Allow
      Action: dynamodb:Query
      Resource: 
        - !Sub "${TweetsTable.Arn}/index/byCreator"
        - !Sub "${TimelinesTable.Arn}/index/distributedFrom"

syncUsersToAlgolia:
  handler: functions/sync-users-to-algolia.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt UsersTable.StreamArn
  iamRoleStatements:
    - Effect: Allow
      Action: ssm:GetParameters
      Resource:
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-app-id
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-admin-key

syncTweetsToAlgolia:
  handler: functions/sync-tweets-to-algolia.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt TweetsTable.StreamArn
  iamRoleStatements:
    - Effect: Allow
      Action: ssm:GetParameters
      Resource:
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-app-id
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-admin-key

search:
  handler: functions/search.handler
  iamRoleStatements:
    - Effect: Allow
      Action: ssm:GetParameters
      Resource:
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-app-id
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-admin-key

searchHashtags:
  handler: functions/search-hashtags.handler
  iamRoleStatements:
    - Effect: Allow
      Action: ssm:GetParameters
      Resource:
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-app-id
        - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${self:custom.stage}/algolia-admin-key

notify:
  handler: functions/notify.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt TweetsTable.StreamArn
  environment:
    APPSYNC_URL: ${appsync:url}
    TWEETS_TABLE: !Ref TweetsTable
    USERS_TABLE: !Ref UsersTable
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
      Resource: !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: 
        - appsync:GraphQL
      Resource: 
        - !Sub ${GraphQlApi.Arn}/types/Mutation/fields/notifyRetweeted
        - !Sub ${GraphQlApi.Arn}/types/Mutation/fields/notifyMentioned
    - Effect: Allow
      Action: dynamodb:Query
      Resource: !Sub "${UsersTable.Arn}/index/byScreenName"

notifyLiked:
  handler: functions/notifyLiked.handler
  events:
    - stream:
       type: dynamodb
       arn: !GetAtt TweetLikesTable.StreamArn
  environment:
    APPSYNC_URL: ${appsync:url}
    TWEETS_TABLE: !Ref TweetsTable
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
      Resource: !GetAtt TweetsTable.Arn
    - Effect: Allow
      Action: 
        - appsync:GraphQL
      Resource: !Sub ${GraphQlApi.Arn}/types/Mutation/fields/notifyLiked